locals {
  # ----------------------------------------------------------------------------------------------
  # Project Informations
  # ----------------------------------------------------------------------------------------------
  suffix     = random_id.this.hex
  account_id = data.aws_caller_identity.this.account_id

  # ----------------------------------------------------------------------------------------------
  # Iot Rule
  # ----------------------------------------------------------------------------------------------
  topic_rule_status = "${var.project_name}_status"

  # ----------------------------------------------------------------------------------------------
  # Kinesis
  # ----------------------------------------------------------------------------------------------
  kinesis_data_stream_iot = "${var.project_name}_events"

  # ----------------------------------------------------------------------------------------------
  # S3 Buckets
  # ----------------------------------------------------------------------------------------------
  bucket_name_materials = "${var.project_name}-materials-${local.suffix}"

  # ----------------------------------------------------------------------------------------------
  # Lambda
  # ----------------------------------------------------------------------------------------------
  lambda_runtime_nodejs = "nodejs14.x"
  lambda_handler_nodejs = "index.handler"
}

# ----------------------------------------------------------------------------------------------
# AWS Account
# ----------------------------------------------------------------------------------------------
data "aws_caller_identity" "this" {}

# ----------------------------------------------------------------------------------------------
# Bucket Random Id
# ----------------------------------------------------------------------------------------------
resource "random_id" "this" {
  byte_length = 3
}

# ----------------------------------------------------------------------------------------------
# Archive file - Lambda default module
# ----------------------------------------------------------------------------------------------
data "archive_file" "lambda_module" {
  type        = "zip"
  output_path = "${path.module}/dist/default.zip"

  source {
    content  = <<EOT
exports.handler = async (event) => {
  const response = {
    statusCode: 200,
    body: JSON.stringify('Hello from Lambda!'),
  };
  return response;
};
EOT
    filename = "index.js"
  }
}
